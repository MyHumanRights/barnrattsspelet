import 'react-loading-skeleton/dist/skeleton.css'
import '../global.scss'
import '../index.scss'

import type { Metadata } from 'next'
import { Bangers, Quicksand } from 'next/font/google'
import { headers } from 'next/headers'
import { notFound } from 'next/navigation'
import { userAgent } from 'next/server'
import { NextIntlClientProvider } from 'next-intl'
import { setRequestLocale } from 'next-intl/server'
import { ReactNode } from 'react'

import avatarJson from '@/data/avatar.json'
import { getDefaultAvatorParts } from '@/utils/avatar-utils'
import { IAvatarColors, IAvatarParts } from '@/utils/types'

import { DeviceTracker } from './components/DeviceTracker'
import RootProviders from './components/RootProviders'
import { Settings } from './components/Settings'
import styles from './layout.module.scss'

const quicksand = Quicksand({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-quicksand',
})
const bangers = Bangers({
  subsets: ['latin'],
  variable: '--font-bangers',
  display: 'swap',
  weight: '400',
})

const locales = ['sv']

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
}

export function generateStaticParams() {
  return locales.map((locale) => ({ locale }))
}

const RootLayout = async (props: {
  children: ReactNode
  params: Promise<{ locale: string }>
}) => {
  const { children } = props
  const params = await props.params
  const { locale } = params
  setRequestLocale(locale)

  // Validate that the incoming `locale` parameter is valid
  const isValidLocale = locales.some((cur) => cur === locale)
  const timeZone = 'Europe/Stockholm'
  if (!isValidLocale) notFound()

  let messages
  try {
    messages = (await import(`../../messages/${locale}.json`)).default
  } catch (error) {
    notFound()
  }

  const defaultAvatarParts = getDefaultAvatorParts(
    avatarJson.parts as IAvatarParts
  )

  // Get device type from user agent (GDPR compliant - no PII)
  const headersList = await headers()
  const ua = userAgent({ headers: headersList })
  const deviceType =
    ua.device.type === 'mobile'
      ? 'mobile'
      : ua.device.type === 'tablet'
      ? 'tablet'
      : 'desktop'

  return (
    <html lang={locale}>
      <body className={`${quicksand.variable} ${bangers.variable}`}>
        <div
          className={styles.App}
          // style={{ height: height }}
        >
          <div className={styles.wrapper}>
            <RootProviders>
              <NextIntlClientProvider
                locale={locale}
                timeZone={timeZone}
                messages={messages}
              >
                <DeviceTracker deviceType={deviceType} />
                <Settings
                  defaultAvatarParts={defaultAvatarParts}
                  avatarColors={avatarJson.colors as IAvatarColors}
                />
                {children}
              </NextIntlClientProvider>
            </RootProviders>
          </div>
        </div>
        <div id='modal'></div>
      </body>
    </html>
  )
}

export default RootLayout
